{% load static %}
<div class="tab-pane active">
    <h2 class="mb-4">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ä–∞–±–æ—á–µ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –∏ –∑–∞–¥–∞—á–∏</h2>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–º -->
    <div class="row mb-3 align-items-center">
        <div class="col-md-6">
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="prevMonth()">‚óÄ –ü—Ä–µ–¥.</button>
                <button class="btn btn-outline-primary" onclick="todayMonth()">–°–µ–≥–æ–¥–Ω—è</button>
                <button class="btn btn-outline-primary" onclick="nextMonth()">–°–ª–µ–¥. ‚ñ∂</button>
            </div>
            <span class="ms-3 h5" id="monthYearDisplay"></span>
        </div>
        <div class="col-md-6 text-end">
            <span id="workStats" class="badge bg-info fs-6">–†–∞–±–æ—á–∏—Ö: 0, –í—ã—Ö–æ–¥–Ω—ã—Ö: 0</span>
        </div>
    </div>

    <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
    <div class="row mb-3">
        <div class="col-12 d-flex flex-wrap gap-3">
            <span><span class="legend-color" style="background:#e7f3ff;"></span> –†–∞–±–æ—á–∏–π –¥–µ–Ω—å</span>
            <span><span class="legend-color" style="background:#f8f8f8;"></span> –í—ã—Ö–æ–¥–Ω–æ–π</span>
            <span><span class="legend-color" style="background:#d4edda;"></span> –°–µ–≥–æ–¥–Ω—è</span>
            <span><span class="legend-color" style="border:2px solid #0078d4; background:white;"></span> –í—ã–±—Ä–∞–Ω–Ω—ã–π</span>
            <span><span class="legend-color" style="background:#28a745;"></span> –ï—Å—Ç—å –∑–∞–¥–∞—á–∏</span>
        </div>
    </div>

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è —Å–µ—Ç–∫–∞ -->
    <div class="row">
        <div class="col-md-8">
            <div id="calendarContainer" class="border rounded p-3 bg-white" style="min-width: 100%; overflow-x: auto;">
                <!-- –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ -->
                <div class="row g-0 text-center fw-bold bg-light rounded-top">
                    <div class="col">–ü–Ω</div>
                    <div class="col">–í—Ç</div>
                    <div class="col">–°—Ä</div>
                    <div class="col">–ß—Ç</div>
                    <div class="col">–ü—Ç</div>
                    <div class="col bg-secondary bg-opacity-10">–°–±</div>
                    <div class="col bg-secondary bg-opacity-10">–í—Å</div>
                </div>
                <div id="calendarDays" class="row g-0"></div>
            </div>
        </div>

        <!-- –ó–∞–¥–∞—á–∏ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å ‚Äî –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å–≤–µ—Ä—Ö—É -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-check2-square"></i> –ó–∞–¥–∞—á–∏ –Ω–∞ –¥–µ–Ω—å: <span id="selectedDateLabel">--.--.----</span>
                </div>
                <div class="card-body">
                    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ -->
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="newTaskInput" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞">
                        <button class="btn btn-success" onclick="addTask()">‚ûï</button>
                    </div>
                    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
                    <div id="tasksList" style="min-height: 200px; max-height: 300px; overflow-y: auto;">
                        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ---------- –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è ---------- */
.calendar-cell {
    min-height: 90px;
    height: 100%;
    width: 100%;
    border: 1px solid #dee2e6;
    background-color: white;
    padding: 8px;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 4px;
}
.calendar-cell:hover {
    background-color: #f0f7ff;
    box-shadow: inset 0 0 0 1px #0078d4;
}
.day-number {
    font-size: 1.1rem;
    font-weight: 500;
}
.work-day {
    background-color: #e7f3ff !important;
}
.rest-day {
    background-color: #f8f8f8 !important;
}
.today {
    background-color: #d4edda !important;
    border: 2px solid #28a745 !important;
}
.selected-day {
    border: 3px solid #0078d4 !important;
    box-shadow: 0 0 0 2px rgba(0,120,212,0.2);
}
.task-indicator {
    position: absolute;
    bottom: 5px;
    right: 5px;
    background: #28a745;
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    text-align: center;
    line-height: 22px;
    font-size: 12px;
    font-weight: bold;
}
.legend-color {
    display: inline-block;
    width: 16px;
    height: 16px;
    margin-right: 5px;
    border-radius: 4px;
    vertical-align: middle;
}
#calendarContainer {
    background: white;
    border-radius: 8px;
}
#calendarDays .col {
    padding: 2px;
}
#tasksList .task-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    margin-bottom: 4px;
    background-color: #f8f9fa;
    border-radius: 4px;
}
.task-item.completed .task-text {
    text-decoration: line-through;
    color: #6c757d;
}
</style>

<script>
var currentYear, currentMonth;
var selectedDate = null;
var workSchedule = {};
var tasksData = {};

window.init_schedule = function() {
    var today = new Date();
    currentYear = today.getFullYear();
    currentMonth = today.getMonth() + 1;
    loadSchedule(currentYear, currentMonth);
};

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Å —Å–µ—Ä–≤–µ—Ä–∞
function loadSchedule(year, month) {
    $.get('/api/schedule/', {year: year, month: month}, function(data) {
        workSchedule = data.work_schedule;
        tasksData = data.tasks;
        renderCalendar(year, month);
        updateMonthDisplay(year, month);
        updateWorkStats();
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –µ—Å—Ç—å, –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë –∑–∞–¥–∞—á–∏
        if (selectedDate) {
            loadTasksForDate(selectedDate);
        }
    });
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–∫—É—â–∏–µ workSchedule –∏ tasksData)
function renderCalendar(year, month) {
    var firstDay = new Date(year, month-1, 1);
    var startDayOfWeek = firstDay.getDay();
    startDayOfWeek = (startDayOfWeek === 0) ? 6 : startDayOfWeek - 1;
    
    var daysInMonth = new Date(year, month, 0).getDate();
    
    var html = '';
    var dayCounter = 1;
    var today = new Date();
    var isTodayYear = today.getFullYear() === year;
    var isTodayMonth = today.getMonth()+1 === month;
    var todayDate = today.getDate();
    
    for (var r = 0; r < 6; r++) {
        html += '<div class="row g-0">';
        for (var c = 0; c < 7; c++) {
            if (r === 0 && c < startDayOfWeek) {
                html += '<div class="col p-1" style="min-width: 0;"></div>';
            } else if (dayCounter <= daysInMonth) {
                var day = dayCounter;
                var dateKey = year + '-' + String(month).padStart(2,'0') + '-' + String(day).padStart(2,'0');
                var isWorkDay = workSchedule[day] === true;
                var isToday = isTodayYear && isTodayMonth && day === todayDate;
                var isSelected = selectedDate === dateKey;
                var hasTasks = tasksData[day] && tasksData[day].length > 0;
                
                var classes = 'calendar-cell';
                if (isWorkDay) classes += ' work-day';
                if (isToday) classes += ' today';
                
                html += '<div class="col p-1">';
                html += '<div class="' + classes + '" data-date="' + dateKey + '" onclick="selectDate(\'' + dateKey + '\')" style="' + (isSelected ? 'border:3px solid #0078d4;' : '') + '">';
                html += '<span class="day-number">' + day + '</span>';
                if (hasTasks) {
                    html += '<span class="task-indicator">' + tasksData[day].length + '</span>';
                }
                html += '</div>';
                html += '</div>';
                dayCounter++;
            } else {
                html += '<div class="col p-1" style="min-width: 0;"></div>';
            }
        }
        html += '</div>';
        if (dayCounter > daysInMonth) break;
    }
    $('#calendarDays').html(html);
}

function updateMonthDisplay(year, month) {
    var monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                     '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
    $('#monthYearDisplay').text(monthNames[month-1] + ' ' + year);
}

function updateWorkStats() {
    var workCount = 0, restCount = 0;
    for (var d in workSchedule) {
        if (workSchedule[d]) workCount++;
        else restCount++;
    }
    $('#workStats').text('–†–∞–±–æ—á–∏—Ö: ' + workCount + ', –í—ã—Ö–æ–¥–Ω—ã—Ö: ' + restCount);
}

function prevMonth() {
    if (currentMonth === 1) {
        currentYear--;
        currentMonth = 12;
    } else {
        currentMonth--;
    }
    loadSchedule(currentYear, currentMonth);
}

function nextMonth() {
    if (currentMonth === 12) {
        currentYear++;
        currentMonth = 1;
    } else {
        currentMonth++;
    }
    loadSchedule(currentYear, currentMonth);
}

function todayMonth() {
    var today = new Date();
    currentYear = today.getFullYear();
    currentMonth = today.getMonth() + 1;
    loadSchedule(currentYear, currentMonth);
}

function selectDate(dateStr) {
    selectedDate = dateStr;
    $('#selectedDateLabel').text(dateStr.replace(/-/g, '.'));
    $('.calendar-cell').removeClass('selected-day').css('border', '');
    $('.calendar-cell[data-date="' + dateStr + '"]').addClass('selected-day');
    loadTasksForDate(dateStr);
}

function loadTasksForDate(dateStr) {
    var day = parseInt(dateStr.split('-')[2]);
    var tasks = tasksData[day] || [];
    var html = '';
    if (tasks.length === 0) {
        html = '<p class="text-muted text-center">–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</p>';
    } else {
        tasks.forEach(function(t) {
            html += '<div class="task-item ' + (t.completed ? 'completed' : '') + '">';
            html += '<div class="form-check">';
            html += '<input class="form-check-input" type="checkbox" id="task' + t.id + '" ' + (t.completed ? 'checked' : '') + ' onchange="toggleTask(' + t.id + ')">';
            html += '<label class="form-check-label task-text" for="task' + t.id + '">' + escapeHtml(t.task) + '</label>';
            html += '</div>';
            html += '<button class="btn btn-sm btn-danger" onclick="deleteTask(' + t.id + ')">√ó</button>';
            html += '</div>';
        });
    }
    $('#tasksList').html(html);
}

// ========== –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï –ó–ê–î–ê–ß–ò ==========
function deleteTask(taskId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
        $.post('/api/tasks/delete/', {id: taskId})
            .done(function() {
                // –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ tasksData
                for (let day in tasksData) {
                    tasksData[day] = tasksData[day].filter(t => t.id !== taskId);
                    if (tasksData[day].length === 0) {
                        delete tasksData[day];
                    }
                }
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –±–µ–∑ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                renderCalendar(currentYear, currentMonth);
                if (selectedDate) {
                    loadTasksForDate(selectedDate);
                }
            });
    }
}

// ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –ó–ê–î–ê–ß–ò ==========
function toggleTask(taskId) {
    $.post('/api/tasks/toggle/', {id: taskId})
        .done(function(data) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            for (let day in tasksData) {
                tasksData[day] = tasksData[day].map(t => 
                    t.id === taskId ? {...t, completed: data.completed} : t
                );
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            renderCalendar(currentYear, currentMonth);
            if (selectedDate) {
                loadTasksForDate(selectedDate);
            }
        });
}

// ========== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–î–ê–ß–ò ==========
function addTask() {
    if (!selectedDate) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ');
        return;
    }
    var taskText = $('#newTaskInput').val().trim();
    if (!taskText) return;
    $.post('/api/tasks/add/', {date: selectedDate, task: taskText})
        .done(function(res) {
            $('#newTaskInput').val('');
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –≤ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            var day = parseInt(selectedDate.split('-')[2]);
            if (!tasksData[day]) tasksData[day] = [];
            tasksData[day].push({
                id: res.id,
                task: res.task,
                completed: res.completed
            });
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            renderCalendar(currentYear, currentMonth);
            loadTasksForDate(selectedDate);
        });
}

function escapeHtml(text) {
    var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>