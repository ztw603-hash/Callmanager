{% load static %}
<div class="tab-pane active">
    <h2 class="mb-4">üîç –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫</h2>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">‚ûï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</div>
        <div class="card-body">
            <form id="trackingForm">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>–ó–∞—è–≤–∫–∞</label>
                            <input type="text" class="form-control" id="claimInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–û–û –†–æ–º–∞—à–∫–∞" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input type="text" class="form-control" id="phoneInput" placeholder="8XXXXXXXXXX" required>
                            <small class="form-text text-muted">–§–æ—Ä–º–∞—Ç: 8XXXXXXXXXX</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>–ù–æ–º–µ—Ä –°–†–ú</label>
                            <input type="text" class="form-control" id="crmInput" placeholder="CRM-12345" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</label>
                            <input type="datetime-local" class="form-control" id="connectionDatetime" required>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary" onclick="clearTrackingForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover" id="trackingTable">
            <thead class="table-light">
                <tr>
                    <th><input type="checkbox" id="selectAllTracking"></th>
                    <th>ID</th>
                    <th>–ó–∞—è–≤–∫–∞</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–ù–æ–º–µ—Ä –°–†–ú</th>
                    <th>–î–∞—Ç–∞/–≤—Ä–µ–º—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</th>
                    <th>ID –∑–≤–æ–Ω–∫–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="trackingTableBody">
                <tr><td colspan="9" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <button class="btn btn-danger" onclick="deleteSelectedTracking()">üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏
window.init_tracking = function() {
    loadTracking();
    setupTrackingForm();
    var now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    $('#connectionDatetime').val(now.toISOString().slice(0,16));
};

function normalizePhone(phone) {
    if (!phone) return phone;
    var digits = phone.replace(/\D/g, '');
    if (digits.length === 10) {
        digits = '8' + digits;
    } else if (digits.length === 11 && digits[0] === '7') {
        digits = '8' + digits.slice(1);
    } else if (digits.length === 11 && digits[0] === '8') {
        // —É–∂–µ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    } else {
        return null;
    }
    return digits;
}

$(document).on('blur', '#phoneInput', function() {
    var normalized = normalizePhone($(this).val());
    if (normalized) $(this).val(normalized);
});

function loadTracking() {
    $.get('/api/tracking/')
        .done(function(data) {
            var tbody = $('#trackingTableBody');
            tbody.empty();
            if (data.tracking.length === 0) {
                tbody.append('<tr><td colspan="9" class="text-center">–ù–µ—Ç –∑–∞—è–≤–æ–∫</td></tr>');
            } else {
                data.tracking.forEach(function(t) {
                    var statusBadge = '';
                    if (t.completed) {
                        statusBadge = '<span class="badge bg-success">–í—ã–ø–æ–ª–Ω–µ–Ω–∞</span>';
                    } else {
                        statusBadge = '<span class="badge bg-primary">–ê–∫—Ç–∏–≤–Ω–∞</span>';
                    }
                    var row = '<tr>';
                    row += '<td><input type="checkbox" class="tracking-checkbox" value="' + t.tracking_id + '"></td>';
                    row += '<td>' + t.tracking_id + '</td>';
                    row += '<td>' + escapeHtml(t.claim) + '</td>';
                    row += '<td>' + escapeHtml(t.phone) + '</td>';
                    row += '<td>' + escapeHtml(t.crm) + '</td>';
                    row += '<td>' + t.connection_datetime + '</td>';
                    row += '<td><a href="#" onclick="jumpToCall(' + t.call_record_id + ')">' + (t.call_record_id || '-') + '</a></td>';
                    row += '<td>' + statusBadge + '</td>';
                    row += '<td><button class="btn btn-sm btn-danger" onclick="deleteTracking(' + t.tracking_id + ')">√ó</button></td>';
                    row += '</tr>';
                    tbody.append(row);
                });
            }
        });
}

function setupTrackingForm() {
    $('#trackingForm').off('submit').on('submit', function(e) {
        e.preventDefault();
        addTracking();
    });
}

function addTracking() {
    var claim = $('#claimInput').val().trim();
    var phone = normalizePhone($('#phoneInput').val().trim());
    var crm = $('#crmInput').val().trim();
    var connDt = $('#connectionDatetime').val();
    
    if (!claim || !phone || !crm || !connDt) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
    }
    
    if (!/^8\d{10}$/.test(phone)) {
        alert('–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ 8XXXXXXXXXX (11 —Ü–∏—Ñ—Ä)');
        return;
    }
    
    $.post('/api/tracking/add/', {
        claim: claim,
        phone: phone,
        crm: crm,
        connection_datetime: connDt
    })
    .done(function() {
        clearTrackingForm();
        loadTracking();
        if (typeof loadCalls === 'function') loadCalls();
    })
    .fail(function(xhr) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + xhr.responseText);
    });
}

function clearTrackingForm() {
    $('#claimInput').val('');
    $('#phoneInput').val('');
    $('#crmInput').val('');
    var now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    $('#connectionDatetime').val(now.toISOString().slice(0,16));
}

function deleteSelectedTracking() {
    var ids = [];
    $('.tracking-checkbox:checked').each(function() {
        ids.push($(this).val());
    });
    if (ids.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫–∏');
        return;
    }
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏? –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∏ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
    $.post('/api/tracking/delete/', {ids: ids})
        .done(function() {
            loadTracking();
            if (typeof loadCalls === 'function') loadCalls();
        });
}

function deleteTracking(id) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')) {
        $.post('/api/tracking/delete/', {ids: [id]})
            .done(function() {
                loadTracking();
                if (typeof loadCalls === 'function') loadCalls();
            });
    }
}

function jumpToCall(callId) {
    if (!callId) return;
    loadTab('calls');
    setTimeout(function() {
        $('#callsTableBody tr').each(function() {
            var idCell = $(this).find('td:eq(1)');
            if (idCell.text() == callId) {
                $(this).addClass('table-primary');
                $(this)[0].scrollIntoView({behavior: 'smooth', block: 'center'});
            }
        });
    }, 500);
}

$('#selectAllTracking').off('change').on('change', function() {
    $('.tracking-checkbox').prop('checked', $(this).prop('checked'));
});

function escapeHtml(text) {
    var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>