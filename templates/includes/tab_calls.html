{% load static %}
<div class="tab-pane active">
    <h2 class="mb-4">üìã –ñ—É—Ä–Ω–∞–ª –∑–≤–æ–Ω–∫–æ–≤</h2>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        </div>
        <div class="card-body">
            <form id="callForm">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <input type="text" class="form-control" id="callComment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input type="text" class="form-control" id="callPhone" placeholder="8XXXXXXXXXX" required>
                            <small class="form-text text-muted">–§–æ—Ä–º–∞—Ç: 8XXXXXXXXXX (11 —Ü–∏—Ñ—Ä)</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>–¢–∏–ø</label>
                            <select class="form-control" id="callTypeSelect">
                                <option value="–ù–µ–¥–æ–∑–≤–æ–Ω">üìû –ù–µ–¥–æ–∑–≤–æ–Ω</option>
                                <option value="–ü–µ—Ä–µ–∑–≤–æ–Ω">‚è∞ –†—É—á–Ω–æ–π –ø–µ—Ä–µ–∑–≤–æ–Ω</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>–í—Ä–µ–º—è –ø–µ—Ä–µ–∑–≤–æ–Ω–∞</label>
                            <input type="datetime-local" class="form-control" id="callNextAttempt" disabled>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary" onclick="clearCallForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-success rounded-3 px-3" onclick="addAttempt()">‚è∞ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
                <button class="btn btn-danger rounded-3 px-3" onclick="deleteSelected()">üóë –£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-info rounded-3 px-3" onclick="copyPhone()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω</button>
                <button class="btn btn-secondary rounded-3 px-3" onclick="copyComment()">üìù –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text">üìÖ –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ</span>
                <select class="form-select" id="dateFilter">
                    <option value="">–í—Å–µ –∑–∞–ø–∏—Å–∏</option>
                </select>
                <button class="btn btn-outline-secondary" type="button" onclick="resetDateFilter()">–°–±—Ä–æ—Å</button>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card bg-light">
                <div class="card-body">
                    <span id="totalLabel" class="badge bg-secondary me-3">–í—Å–µ–≥–æ: 0</span>
                    <span id="overdueLabel" class="badge bg-danger me-3">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: 0</span>
                    <span id="nextLabel" class="badge bg-info">–°–ª–µ–¥—É—é—â–∏–π –∑–≤–æ–Ω–æ–∫: --:--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–≤–æ–Ω–∫–æ–≤ -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover table-calls" id="callsTable">
            <thead class="table-light">
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>ID</th>
                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞</th>
                    <th>–°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞</th>
                    <th>–ü–æ–ø—ã—Ç–∫–∞</th>
                    <th>–í—Ä–µ–º—è –¥–æ –∑–≤–æ–Ω–∫–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–¢–∏–ø</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="callsTableBody">
                <tr><td colspan="11" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div class="modal fade" id="adjustTimeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∑–≤–æ–Ω–∫–∞</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adjustTimeForm">
                    <input type="hidden" id="adjustCallId">
                    <div class="mb-3">
                        <label for="adjustNextAttempt" class="form-label fw-bold">–ù–æ–≤–æ–µ –≤—Ä–µ–º—è –∑–≤–æ–Ω–∫–∞</label>
                        <input type="datetime-local" class="form-control" id="adjustNextAttempt" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveAdjustedTime()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editCommentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCommentForm">
                    <input type="hidden" id="editCommentCallId">
                    <div class="mb-3">
                        <label for="editCommentText" class="form-label fw-bold">–ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <input type="text" class="form-control" id="editCommentText" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-info" onclick="saveComment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editPhoneModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">üìû –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPhoneForm">
                    <input type="hidden" id="editPhoneCallId">
                    <div class="mb-3">
                        <label for="editPhoneText" class="form-label fw-bold">–ù–æ–≤—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                        <input type="text" class="form-control" id="editPhoneText" placeholder="8XXXXXXXXXX" required>
                        <div class="form-text text-muted">–§–æ—Ä–º–∞—Ç: 8XXXXXXXXXX (11 —Ü–∏—Ñ—Ä)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-info" onclick="savePhone()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏
window.init_calls = function() {
    loadDateFilterOptions();
    setupEventListeners();
    startTimeUpdater();
};

let timeUpdateInterval = null;

function startTimeUpdater() {
    if (timeUpdateInterval) clearInterval(timeUpdateInterval);
    timeUpdateInterval = setInterval(updateTimeUntil, 5000);
}

function updateTimeUntil() {
    $('#callsTableBody tr').each(function() {
        const row = $(this);
        const nextAttemptCell = row.find('td:eq(5)');
        if (nextAttemptCell.length) {
            const nextAttemptText = nextAttemptCell.text();
            let nextDate = new Date(nextAttemptText.replace(' ', 'T'));
            let oldStatus = row.find('td:eq(8)').text().trim(); // —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏–∑ —è—á–µ–π–∫–∏
            let timeUntil = calculateTimeUntil(nextDate);
            let newStatus = calculateNotificationStatus(nextDate);
            
            row.find('td:eq(7)').text(timeUntil);
            
            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –∏ —Å—Ç–∞–ª "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" ‚Äì –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ
            if (oldStatus !== newStatus && newStatus === '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ') {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∞ –∏–∑ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
                const callId = row.find('td:eq(1)').text(); // ID
                const comment = row.find('td:eq(2)').text();
                const phone = row.find('td:eq(3) span').text(); // –Ω–æ–º–µ—Ä –∏–∑ <span>
                const nextAttempt = nextAttemptText;
                
                // –í—ã–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                if (window.showNotification) {
                    window.showNotification({
                        id: callId,
                        comment: comment,
                        phone: phone,
                        next_attempt: nextAttempt
                    });
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞
            let statusBadge = '';
            if (newStatus === '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ') statusBadge = '<span class="badge bg-danger">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>';
            else if (newStatus === '–°–∫–æ—Ä–æ') statusBadge = '<span class="badge bg-warning text-dark">–°–∫–æ—Ä–æ</span>';
            else if (newStatus === '–ë–ª–∏–∑–∫–æ') statusBadge = '<span class="badge bg-info">–ë–ª–∏–∑–∫–æ</span>';
            else statusBadge = '<span class="badge bg-secondary">–ó–∞–ø–ª–∞–Ω–∏—Ä–∞–Ω</span>';
            row.find('td:eq(8)').html(statusBadge);
        }
    });
    updateStatsFromTable();
}

function calculateTimeUntil(nextDate) {
    const now = new Date();
    if (nextDate <= now) return "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ";
    
    const diffMs = nextDate - now;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    const diffSeconds = Math.floor((diffMs % (1000 * 60)) / 1000);
    
    if (diffDays > 0) {
        return `${diffDays}–¥ ${diffHours}—á`;
    } else if (diffHours > 0) {
        return `${diffHours}—á ${diffMinutes}–º`;
    } else if (diffMinutes > 0) {
        return `${diffMinutes}–º ${diffSeconds}—Å`;
    } else {
        return `${diffSeconds}—Å`;
    }
}

function calculateNotificationStatus(nextDate) {
    const now = new Date();
    const diffMs = nextDate - now;
    const diffSeconds = Math.floor(diffMs / 1000);
    
    if (diffSeconds <= 0) return "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ";
    if (diffSeconds <= 300) return "–°–∫–æ—Ä–æ";
    if (diffSeconds <= 900) return "–ë–ª–∏–∑–∫–æ";
    return "–ó–∞–ø–ª–∞–Ω–∏—Ä–∞–Ω";
}

function updateStatsFromTable() {
    const rows = $('#callsTableBody tr');
    const total = rows.length;
    let overdue = 0;
    let nextCall = null;
    let nextTime = null;
    rows.each(function() {
        const statusCell = $(this).find('td:eq(8)');
        if (statusCell.text().includes('–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ')) overdue++;
        const nextAttemptText = $(this).find('td:eq(5)').text();
        if (nextAttemptText) {
            const dt = new Date(nextAttemptText.replace(' ', 'T'));
            if (dt > new Date()) {
                if (!nextTime || dt < nextTime) {
                    nextTime = dt;
                    nextCall = nextAttemptText;
                }
            }
        }
    });
    $('#totalLabel').text('–í—Å–µ–≥–æ: ' + total);
    $('#overdueLabel').text('–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: ' + overdue);
    $('#nextLabel').text('–°–ª–µ–¥—É—é—â–∏–π –∑–≤–æ–Ω–æ–∫: ' + (nextCall || '--:--'));
}

function normalizePhone(phone) {
    if (!phone) return phone;
    var digits = phone.replace(/\D/g, '');
    if (digits.length === 10) {
        digits = '8' + digits;
    } else if (digits.length === 11 && digits[0] === '7') {
        digits = '8' + digits.slice(1);
    } else if (digits.length === 11 && digits[0] === '8') {
        // —É–∂–µ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    } else {
        return null;
    }
    return digits;
}

$(document).on('blur', '#callPhone, #editPhoneText', function() {
    var normalized = normalizePhone($(this).val());
    if (normalized) $(this).val(normalized);
});

function loadDateFilterOptions() {
    $.get('/api/calls/', function(data) {
        var dates = new Set();
        data.calls.forEach(function(c) {
            var date = c.next_attempt.substring(0,10);
            dates.add(date);
        });
        var select = $('#dateFilter');
        select.empty();
        select.append('<option value="">–í—Å–µ –∑–∞–ø–∏—Å–∏</option>');
        
        var today = new Date();
        var todayStr = today.getFullYear() + '-' + 
                       String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(today.getDate()).padStart(2, '0');
        
        Array.from(dates).sort().reverse().forEach(function(d) {
            var optionText = (d === todayStr) ? 'üìÖ —Å–µ–≥–æ–¥–Ω—è' : d;
            select.append('<option value="' + d + '">' + optionText + '</option>');
        });
        
        setDefaultDateFilter();
    });
}

function setDefaultDateFilter() {
    var today = new Date();
    var year = today.getFullYear();
    var month = String(today.getMonth() + 1).padStart(2, '0');
    var day = String(today.getDate()).padStart(2, '0');
    var todayStr = year + '-' + month + '-' + day;
    
    var select = $('#dateFilter');
    if (select.find('option[value="' + todayStr + '"]').length > 0) {
        select.val(todayStr);
    } else {
        select.val('');
    }
    loadCalls();
}

function resetDateFilter() {
    $('#dateFilter').val('');
    loadCalls();
}

function loadCalls() {
    var filterDate = $('#dateFilter').val();
    $.get('/api/calls/', {date: filterDate}, function(data) {
        var tbody = $('#callsTableBody');
        tbody.empty();
        if (data.calls.length === 0) {
            tbody.append('<tr><td colspan="11" class="text-center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>');
        } else {
            data.calls.forEach(function(c) {
                var rowClass = '';
                if (c.call_type === '–ù–µ–¥–æ–∑–≤–æ–Ω') rowClass = 'call-type-nedozvon';
                else if (c.call_type === '–ü–µ—Ä–µ–∑–≤–æ–Ω') rowClass = 'call-type-perezvon';
                else if (c.call_type === '–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ') rowClass = 'call-type-tracking';
                
                var statusBadge = '';
                if (c.notification_status === '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ') statusBadge = '<span class="badge bg-danger">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>';
                else if (c.notification_status === '–°–∫–æ—Ä–æ') statusBadge = '<span class="badge bg-warning text-dark">–°–∫–æ—Ä–æ</span>';
                else if (c.notification_status === '–ë–ª–∏–∑–∫–æ') statusBadge = '<span class="badge bg-info">–ë–ª–∏–∑–∫–æ</span>';
                else statusBadge = '<span class="badge bg-secondary">–ó–∞–ø–ª–∞–Ω–∏—Ä–∞–Ω</span>';
                
                var row = '<tr class="' + rowClass + '">';
                row += '<td><input type="checkbox" class="call-checkbox" value="' + c.id + '"></td>';
                row += '<td>' + c.id + '</td>';
                row += '<td>' + escapeHtml(c.comment) + '</td>';
                
                row += '<td>';
                row += '<div class="d-flex align-items-center gap-2">';
                row += '<button class="btn btn-sm btn-outline-primary rounded-circle" style="width:32px; height:32px;" onclick="window.callUIS(\'' + c.phone + '\')" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ UIS">üìû</button>';
                row += '<span style="cursor: pointer;" onclick="window.copyPhoneNumber(\'' + c.phone + '\', \'table\'); event.stopPropagation();" title="–ö–ª–∏–∫ ‚Äî –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä">' + escapeHtml(c.phone) + '</span>';
                row += '</div>';
                row += '</td>';
                
                row += '<td>' + c.first_attempt + '</td>';
                row += '<td>' + c.next_attempt + '</td>';
                row += '<td>' + c.attempt_number + '</td>';
                row += '<td>' + c.time_until + '</td>';
                row += '<td>' + statusBadge + '</td>';
                row += '<td>' + c.call_type + '</td>';
                
                row += '<td>';
                row += '<div class="d-flex gap-1 justify-content-center">';
                row += '<button class="btn btn-sm btn-outline-primary rounded-circle" style="width:32px; height:32px;" onclick="openEditCommentModal(' + c.id + ', \'' + escapeJsString(c.comment) + '\')" title="–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">‚úèÔ∏è</button>';
                row += '<button class="btn btn-sm btn-outline-success rounded-circle" style="width:32px; height:32px;" onclick="openEditPhoneModal(' + c.id + ', \'' + escapeJsString(c.phone) + '\')" title="–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω">üìû</button>';
                row += '<button class="btn btn-sm btn-outline-warning rounded-circle" style="width:32px; height:32px;" onclick="openAdjustTimeModal(' + c.id + ', \'' + c.next_attempt + '\')" title="–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è">‚è∞</button>';
                row += '</div>';
                row += '</td>';
                
                row += '</tr>';
                tbody.append(row);
            });
        }
        updateStats(data.calls);
    });
}

function escapeJsString(str) {
    return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

function updateStats(calls) {
    var total = calls.length;
    var overdue = 0;
    var nextCall = null;
    var nextTime = null;
    calls.forEach(function(c) {
        if (c.notification_status === '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ') overdue++;
        var dt = new Date(c.next_attempt.replace(' ', 'T'));
        if (dt > new Date()) {
            if (!nextTime || dt < nextTime) {
                nextTime = dt;
                nextCall = c.next_attempt;
            }
        }
    });
    $('#totalLabel').text('–í—Å–µ–≥–æ: ' + total);
    $('#overdueLabel').text('–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: ' + overdue);
    $('#nextLabel').text('–°–ª–µ–¥—É—é—â–∏–π –∑–≤–æ–Ω–æ–∫: ' + (nextCall || '--:--'));
}

function setupEventListeners() {
    $('#callForm').off('submit').on('submit', function(e) {
        e.preventDefault();
        addCall();
    });
    
    $('#callTypeSelect').off('change').on('change', function() {
        if ($(this).val() === '–ù–µ–¥–æ–∑–≤–æ–Ω') {
            $('#callNextAttempt').prop('disabled', true).val('');
        } else {
            $('#callNextAttempt').prop('disabled', false);
            var now = new Date();
            now.setHours(now.getHours() + 1);
            $('#callNextAttempt').val(now.toISOString().slice(0,16));
        }
    }).trigger('change');
    
    $('#selectAll').off('change').on('change', function() {
        $('.call-checkbox').prop('checked', $(this).prop('checked'));
    });
    
    $('#dateFilter').off('change').on('change', function() {
        loadCalls();
    });
}

function addCall() {
    var comment = $('#callComment').val().trim();
    var phone = normalizePhone($('#callPhone').val().trim());
    $('#callPhone').val(phone);
    var callType = $('#callTypeSelect').val();
    var nextAttempt = $('#callNextAttempt').val();
    
    if (!comment || !phone) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ —Ç–µ–ª–µ—Ñ–æ–Ω');
        return;
    }
    
    if (!/^8\d{10}$/.test(phone)) {
        alert('–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ 8XXXXXXXXXX (11 —Ü–∏—Ñ—Ä)');
        return;
    }
    
    var data = {
        comment: comment,
        phone: phone,
        call_type: callType,
        next_attempt: nextAttempt
    };
    
    $.post('/api/calls/add/', data)
        .done(function() {
            clearCallForm();
            loadCalls();
            loadDateFilterOptions();
        })
        .fail(function(xhr) {
            alert('–û—à–∏–±–∫–∞: ' + xhr.responseText);
        });
}

function clearCallForm() {
    $('#callComment').val('');
    $('#callPhone').val('');
    $('#callTypeSelect').val('–ù–µ–¥–æ–∑–≤–æ–Ω').trigger('change');
}

function addAttempt() {
    var ids = getSelectedIds('.call-checkbox');
    if (ids.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å–∏');
        return;
    }
    var promises = ids.map(function(id) {
        return $.post('/api/calls/update/', {id: id});
    });
    Promise.all(promises).then(function() {
        loadCalls();
    }).catch(function() {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ø—ã—Ç–∫–∏');
    });
}

function deleteSelected() {
    var ids = getSelectedIds('.call-checkbox');
    if (ids.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å–∏');
        return;
    }
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏?')) return;
    $.post('/api/calls/delete/', {ids: ids})
        .done(function() {
            loadCalls();
            loadDateFilterOptions();
        });
}

function copyPhone() {
    var ids = getSelectedIds('.call-checkbox');
    if (ids.length === 0) return;
    var phones = [];
    $('#callsTableBody tr').each(function() {
        var cb = $(this).find('.call-checkbox');
        if (cb.is(':checked')) {
            phones.push($(this).find('td:eq(3) span').text());
        }
    });
    navigator.clipboard.writeText(phones.join('\n')).then(function() {
        alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ' + phones.length + ' –Ω–æ–º–µ—Ä–æ–≤');
    });
}

function copyComment() {
    var ids = getSelectedIds('.call-checkbox');
    if (ids.length === 0) return;
    var comments = [];
    $('#callsTableBody tr').each(function() {
        var cb = $(this).find('.call-checkbox');
        if (cb.is(':checked')) {
            comments.push($(this).find('td:eq(2)').text());
        }
    });
    navigator.clipboard.writeText(comments.join('\n')).then(function() {
        alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ' + comments.length + ' –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤');
    });
}

function openAdjustTimeModal(callId, currentNextAttempt) {
    $('#adjustCallId').val(callId);
    var datetimeLocal = currentNextAttempt.replace(' ', 'T');
    $('#adjustNextAttempt').val(datetimeLocal);
    new bootstrap.Modal(document.getElementById('adjustTimeModal')).show();
}

function saveAdjustedTime() {
    var callId = $('#adjustCallId').val();
    var newTime = $('#adjustNextAttempt').val();
    if (!newTime) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è');
        return;
    }
    $.post('/api/calls/adjust/', {
        id: callId,
        next_attempt: newTime
    }).done(function() {
        bootstrap.Modal.getInstance(document.getElementById('adjustTimeModal')).hide();
        loadCalls();
    }).fail(function(xhr) {
        alert('–û—à–∏–±–∫–∞: ' + xhr.responseText);
    });
}

function openEditCommentModal(callId, currentComment) {
    $('#editCommentCallId').val(callId);
    $('#editCommentText').val(currentComment);
    new bootstrap.Modal(document.getElementById('editCommentModal')).show();
}

function saveComment() {
    var callId = $('#editCommentCallId').val();
    var comment = $('#editCommentText').val().trim();
    if (!comment) {
        alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
        return;
    }
    $.post('/api/calls/update_comment/', {
        id: callId,
        comment: comment
    }).done(function() {
        bootstrap.Modal.getInstance(document.getElementById('editCommentModal')).hide();
        loadCalls();
    }).fail(function(xhr) {
        alert('–û—à–∏–±–∫–∞: ' + xhr.responseText);
    });
}

function openEditPhoneModal(callId, currentPhone) {
    $('#editPhoneCallId').val(callId);
    $('#editPhoneText').val(currentPhone);
    new bootstrap.Modal(document.getElementById('editPhoneModal')).show();
}

function savePhone() {
    var callId = $('#editPhoneCallId').val();
    var phone = $('#editPhoneText').val().trim();
    phone = normalizePhone(phone);
    if (!phone) {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
        return;
    }
    if (!/^8\d{10}$/.test(phone)) {
        alert('–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ 8XXXXXXXXXX (11 —Ü–∏—Ñ—Ä)');
        return;
    }
    $.post('/api/calls/update_phone/', {
        id: callId,
        phone: phone
    }).done(function() {
        bootstrap.Modal.getInstance(document.getElementById('editPhoneModal')).hide();
        loadCalls();
    }).fail(function(xhr) {
        alert('–û—à–∏–±–∫–∞: ' + xhr.responseText);
    });
}

function getSelectedIds(checkboxClass) {
    var ids = [];
    $(checkboxClass + ':checked').each(function() {
        ids.push($(this).val());
    });
    return ids;
}

function escapeHtml(text) {
    var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

window.addEventListener('beforeunload', function() {
    if (timeUpdateInterval) clearInterval(timeUpdateInterval);
});
</script>