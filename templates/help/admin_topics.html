{% extends 'base.html' %}
{% load static %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–º{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–º</h2>
        <button class="btn btn-primary" id="addTopicBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º—É</button>
    </div>

    <div id="topics-list">
        {% for topic in topics %}
        <div class="card mb-3" data-topic-id="{{ topic.id }}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ topic.title }}</strong>
                    <span class="badge {% if topic.is_active %}bg-success{% else %}bg-secondary{% endif %} ms-2">
                        {% if topic.is_active %}–ê–∫—Ç–∏–≤–Ω–∞{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω–∞{% endif %}
                    </span>
                    <span class="badge bg-info ms-2">–ü–æ—Ä—è–¥–æ–∫: {{ topic.order }}</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary edit-topic-btn"
                            data-topic-id="{{ topic.id }}"
                            data-topic-title="{{ topic.title|escapejs }}"
                            data-topic-order="{{ topic.order }}"
                            data-topic-active="{{ topic.is_active|lower }}"
                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—É">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-outline-danger delete-topic-btn"
                            data-topic-id="{{ topic.id }}"
                            title="–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É">üóëÔ∏è</button>
                    <button class="btn btn-sm btn-outline-success add-tab-btn"
                            data-topic-id="{{ topic.id }}"
                            title="–î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É">‚ûï –í–∫–ª–∞–¥–∫–∞</button>
                </div>
            </div>
            <div class="card-body">
                {% with tabs=topic.tabs.all %}
                    {% if tabs %}
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</th>
                                    <th>–ü–æ—Ä—è–¥–æ–∫</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tab in tabs %}
                                <tr data-tab-id="{{ tab.id }}">
                                    <td>{{ tab.title }}</td>
                                    <td>{{ tab.content|truncatechars:50 }}</td>
                                    <td>{{ tab.order }}</td>
                                    <td>
                                        <span class="badge {% if tab.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ tab.is_active|yesno:"–ê–∫—Ç–∏–≤–Ω–∞,–ù–µ–∞–∫—Ç–∏–≤–Ω–∞" }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary edit-tab-btn"
                                                data-tab-id="{{ tab.id }}"
                                                data-tab-title="{{ tab.title|escapejs }}"
                                                data-tab-content="{{ tab.content|escapejs }}"
                                                data-tab-order="{{ tab.order }}"
                                                data-tab-active="{{ tab.is_active|lower }}"
                                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∫–ª–∞–¥–∫—É">‚úèÔ∏è</button>
                                        <button class="btn btn-sm btn-outline-danger delete-tab-btn"
                                                data-tab-id="{{ tab.id }}"
                                                title="–£–¥–∞–ª–∏—Ç—å –≤–∫–ª–∞–¥–∫—É">üóëÔ∏è</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">–ù–µ—Ç –≤–∫–ª–∞–¥–æ–∫</p>
                    {% endif %}
                {% endwith %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ç–µ–º—ã -->
<div class="modal fade" id="topicModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="topicModalTitle">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º—É</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="topicForm">
                    <input type="hidden" id="topicId">
                    <div class="mb-3">
                        <label for="topicTitle" class="form-label fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã</label>
                        <input type="text" class="form-control" id="topicTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="topicOrder" class="form-label fw-bold">–ü–æ—Ä—è–¥–æ–∫</label>
                        <input type="number" class="form-control" id="topicOrder" value="0">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="topicActive" checked>
                            <label class="form-check-label" for="topicActive">–ê–∫—Ç–∏–≤–Ω–∞</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveTopicBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ -->
<div class="modal fade" id="tabModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="tabModalTitle">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="tabForm">
                    <input type="hidden" id="tabId">
                    <input type="hidden" id="tabTopicId">
                    <div class="mb-3">
                        <label for="tabTitle" class="form-label fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏</label>
                        <input type="text" class="form-control" id="tabTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="tabContent" class="form-label fw-bold">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</label>
                        <textarea class="form-control" id="tabContent" rows="6" required></textarea>
                        <small class="text-muted">–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.</small>
                    </div>
                    <div class="mb-3">
                        <label for="tabOrder" class="form-label fw-bold">–ü–æ—Ä—è–¥–æ–∫</label>
                        <input type="number" class="form-control" id="tabOrder" value="0">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="tabActive" checked>
                            <label class="form-check-label" for="tabActive">–ê–∫—Ç–∏–≤–Ω–∞</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-success" id="saveTabBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    const csrftoken = '{{ csrf_token }}';

    // ---------- –û–¢–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–û–ö ----------
    function openModal(modalId) {
        new bootstrap.Modal(document.getElementById(modalId)).show();
    }

    // ---------- –¢–ï–ú–´ ----------
    document.getElementById('addTopicBtn')?.addEventListener('click', function() {
        document.getElementById('topicModalTitle').innerText = '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º—É';
        document.getElementById('topicId').value = '';
        document.getElementById('topicTitle').value = '';
        document.getElementById('topicOrder').value = '0';
        document.getElementById('topicActive').checked = true;
        openModal('topicModal');
    });

    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.edit-topic-btn');
        if (!btn) return;
        const id = btn.dataset.topicId;
        const title = btn.dataset.topicTitle;
        const order = btn.dataset.topicOrder;
        const active = btn.dataset.topicActive === 'true';
        document.getElementById('topicModalTitle').innerText = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—É';
        document.getElementById('topicId').value = id;
        document.getElementById('topicTitle').value = title;
        document.getElementById('topicOrder').value = order;
        document.getElementById('topicActive').checked = active;
        openModal('topicModal');
    });

    document.getElementById('saveTopicBtn')?.addEventListener('click', function() {
        const id = document.getElementById('topicId').value;
        const title = document.getElementById('topicTitle').value.trim();
        const order = document.getElementById('topicOrder').value;
        const active = document.getElementById('topicActive').checked;
        if (!title) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã');
            return;
        }
        const url = id ? '/help-admin/edit_topic/' : '/help-admin/add_topic/';
        const data = id ? {id, title, order, is_active: active} : {title};
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.ok ? location.reload() : response.text().then(text => { throw new Error(text); }))
        .catch(error => alert('–û—à–∏–±–∫–∞: ' + error.message));
    });

    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.delete-topic-btn');
        if (!btn || !confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É? –í—Å–µ –≤–∫–ª–∞–¥–∫–∏ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
        const id = btn.dataset.topicId;
        fetch('/help-admin/delete_topic/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({id})
        })
        .then(response => response.ok ? location.reload() : response.text().then(text => { throw new Error(text); }))
        .catch(error => alert('–û—à–∏–±–∫–∞: ' + error.message));
    });

    // ---------- –í–ö–õ–ê–î–ö–ò ----------
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.add-tab-btn');
        if (!btn) return;
        const topicId = btn.dataset.topicId;
        document.getElementById('tabModalTitle').innerText = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É';
        document.getElementById('tabId').value = '';
        document.getElementById('tabTopicId').value = topicId;
        document.getElementById('tabTitle').value = '';
        document.getElementById('tabContent').value = '';
        document.getElementById('tabOrder').value = '0';
        document.getElementById('tabActive').checked = true;
        openModal('tabModal');
    });

    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.edit-tab-btn');
        if (!btn) return;
        const id = btn.dataset.tabId;
        const title = btn.dataset.tabTitle;
        const content = btn.dataset.tabContent;
        const order = btn.dataset.tabOrder;
        const active = btn.dataset.tabActive === 'true';
        document.getElementById('tabModalTitle').innerText = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∫–ª–∞–¥–∫—É';
        document.getElementById('tabId').value = id;
        document.getElementById('tabTopicId').value = '';
        document.getElementById('tabTitle').value = title;
        document.getElementById('tabContent').value = content;
        document.getElementById('tabOrder').value = order;
        document.getElementById('tabActive').checked = active;
        openModal('tabModal');
    });

    document.getElementById('saveTabBtn')?.addEventListener('click', function() {
        const id = document.getElementById('tabId').value;
        const topicId = document.getElementById('tabTopicId').value;
        const title = document.getElementById('tabTitle').value.trim();
        const content = document.getElementById('tabContent').value.trim();
        const order = document.getElementById('tabOrder').value;
        const active = document.getElementById('tabActive').checked;
        if (!title || !content) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ');
            return;
        }
        const url = id ? '/help-admin/edit_tab/' : '/help-admin/add_tab/';
        const data = id ?
            {id, title, content, order, is_active: active} :
            {topic_id: topicId, title, content};
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.ok ? location.reload() : response.text().then(text => { throw new Error(text); }))
        .catch(error => alert('–û—à–∏–±–∫–∞: ' + error.message));
    });

    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.delete-tab-btn');
        if (!btn || !confirm('–£–¥–∞–ª–∏—Ç—å –≤–∫–ª–∞–¥–∫—É?')) return;
        const id = btn.dataset.tabId;
        fetch('/help-admin/delete_tab/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({id})
        })
        .then(response => response.ok ? location.reload() : response.text().then(text => { throw new Error(text); }))
        .catch(error => alert('–û—à–∏–±–∫–∞: ' + error.message));
    });
})();
</script>
{% endblock %}